#!/bin/bash

cc_cfg_file="/etc/confluent-control-center/control-center.properties"

: ${CONTROL_CENTER_BOOTSTRAP_SERVERS:=$KAFKA_PORT_9092_TCP_ADDR:$KAFKA_PORT_9092_TCP_PORT}
: ${CONTROL_CENTER_ZOOKEEPER_CONNECT:=$ZOOKEEPER_PORT_2181_TCP_ADDR:$ZOOKEEPER_PORT_2181_TCP_PORT}
: ${CONTROL_CENTER_CONFLUENT_CONTROLCENTER_CONNECT_CLUSTER:="$HOST:8083"}
: ${CONTROL_CENTER_CONFLUENT_CONTROLCENTER_REST_LISTENERS:="http://0.0.0.0:$PORT0"}
: ${CONTROL_CENTER_LISTENERS:="http://0.0.0.0:$PORT0"}
: ${CONTROL_CENTER_PORT:=$PORT0}
: ${CONTROL_CENTER_CONFLUENT_CONTROLCENTER_ID:=0}
: ${CONTROL_CENTER_CONFLUENT_CONTROLCENTER_LICENSE:=}
: ${CONTROL_CENTER_CONFLUENT_CONTROLCENTER_NAME:=_confluent-controlcenter}
: ${CONTROL_CENTER_CONFLUENT_CONTROLCENTER_DATA_DIR:=/tmp/confluent/control-center}
: ${CONTROL_CENTER_CONFLUENT_CONTROLCENTER_INTERNAL_TOPICS_PARTITIONS:=2}
: ${CONTROL_CENTER_CONFLUENT_CONTROLCENTER_INTERNAL_TOPICS_REPLICATION:=3}
: ${CONTROL_CENTER_CONFLUENT_CONTROLCENTER_INTERNAL_TOPICS_RETENTION_MS:=86400000}
: ${CONTROL_CENTER_CONFLUENT_MONITORING_INTERCEPTOR_TOPIC:=_confluent-monitoring}
: ${CONTROL_CENTER_CONFLUENT_MONITORING_INTERCEPTOR_TOPIC_PARTITIONS:=5}
: ${CONTROL_CENTER_CONFLUENT_MONITORING_INTERCEPTOR_TOPIC_REPLICATION:=3}
: ${CONTROL_CENTER_CONFLUENT_MONITORING_INTERCEPTOR_TOPIC_RETENTION_MS:=259200000}

export CONTROL_CENTER_BOOTSTRAP_SERVERS
export CONTROL_CENTER_ZOOKEEPER_CONNECT
export CONTROL_CENTER_CONFLUENT_CONTROLCENTER_CONNECT_CLUSTER
export CONTROL_CENTER_CONFLUENT_CONTROLCENTER_REST_LISTENERS
export CONTROL_CENTER_LISTENERS
export CONTROL_CENTER_PORT
export CONTROL_CENTER_CONFLUENT_CONTROLCENTER_ID
export CONTROL_CENTER_CONFLUENT_CONTROLCENTER_LICENSE
export CONTROL_CENTER_CONFLUENT_CONTROLCENTER_NAME
export CONTROL_CENTER_CONFLUENT_CONTROLCENTER_DATA_DIR
export CONTROL_CENTER_CONFLUENT_CONTROLCENTER_INTERNAL_TOPICS_PARTITIONS
export CONTROL_CENTER_CONFLUENT_CONTROLCENTER_INTERNAL_TOPICS_REPLICATION
export CONTROL_CENTER_CONFLUENT_CONTROLCENTER_INTERNAL_TOPICS_RETENTION_MS
export CONTROL_CENTER_CONFLUENT_MONITORING_INTERCEPTOR_TOPIC
export CONTROL_CENTER_CONFLUENT_MONITORING_INTERCEPTOR_TOPIC_PARTITIONS
export CONTROL_CENTER_CONFLUENT_MONITORING_INTERCEPTOR_TOPIC_REPLICATION
export CONTROL_CENTER_CONFLUENT_MONITORING_INTERCEPTOR_TOPIC_RETENTION_MS

# Download the config file, if given a URL
if [ ! -z "$CC_CFG_URL" ]; then
  echo "[KC] Downloading KC config file from ${CC_CFG_URL}"
  curl --location --silent --insecure --output ${cc_cfg_file} ${CC_CFG_URL}
  if [ $? -ne 0 ]; then
    echo "[KC] Failed to download ${CC_CFG_URL} exiting."
    exit 1
  fi
fi

echo '# Generated by confluent-control-center.sh' > ${cc_cfg_file}
for var in $(env | grep '^CONTROL_CENTER_' | sort); do
  key=$(echo $var | sed -r 's/CONTROL_CENTER_(.*)=.*/\1/g' | tr A-Z a-z | tr _ .)
  value=$(echo $var | sed -r 's/.*=(.*)/\1/g')
  echo "${key}=${value}" >> ${cc_cfg_file}
done

exec /usr/bin/control-center-start ${cc_cfg_file}
